/*
  * Sear.js 0.3.0
  * (c) 2020 dragonwocky <thedragonring.bod@gmail.com>
  * (https://dragonwocky.me/) under the MIT License
  */

function Sear(options){"use strict";const raw={...options.data,...retrieve(options.t)},cache={};function clone(e,t){return Object.keys(t).forEach(n=>Array.isArray(t[n])?(e[n]=[],clone(e[n],t[n])):"object"==typeof t[n]?(e[n]={},clone(e[n],t[n])):"function"==typeof t[n]?e[n]=void 0:void(e[n]=t[n])),!0}clone(cache,raw);const proxied=new Proxy(raw,validator()),dependency={target:null,o:{}},signals={},watchers=options.watch||{};function persist(){const e={};clone(e,raw);const t={};Object.keys(raw).filter(t=>"function"==typeof e[t]).forEach(n=>{t[n]=e[n].toString().trim(),delete e[n]}),localStorage[options.t]=JSON.stringify({data:e,s:t})}function retrieve(store){try{if(store=JSON.parse(localStorage[store]||"{}"),store&&"object"==typeof store)return store.data=store.data||{},store.s=store.s||{},Object.keys(store.s).forEach(key=>{try{eval(`store.computed[key] = (${store.s[key].startsWith("function")?"":"function"} ${store.s[key]})`)}catch(e){store.s[key]=new Function(`return (${store.s[key].startsWith("function")?"":"function"} ${store.s[key]})`)()}}),{...store.data,...store.s}}catch(e){return{}}}function arrayHandler(e=[]){return{get:(e,t)=>e[t],set:(t,n,o)=>(t[n]=o,notify([...e]),!0)}}function validator(e=[]){return{get(t,n){if(!(n in t))return;const o=[...e,n].join(".");if("function"==typeof t[n]){dependency.target||(dependency.target=o),observe(o,()=>set(cache,o,"")),get(cache,o)||set(cache,o,t[n].call(proxied));const e=get(cache,o);return dependency.target=null,e}return dependency.target&&(dependency.o[dependency.target]||(dependency.o[dependency.target]=[]),dependency.o[dependency.target].includes(o)||dependency.o[dependency.target].push(o)),Array.isArray(t[n])?new Proxy(t[n],arrayHandler([...e,n])):"object"==typeof t[n]&&null!==t[n]?new Proxy(t[n],validator([...e,n])):t[n]},set(t,n,o){const r=[...e,n].join(".");return t[n]=o,Object.keys(dependency.o).forEach(e=>{dependency.o[e].includes(r)&&notify(e)}),notify([...e,n]),!0}}}function get(e,t){for(t=Array.isArray(t)?t:t.split(".");t.length>1;)if(!(e=e[t.shift()]))return;return e[t]}function set(e,t,n){for(t=Array.isArray(t)?t:t.split(".");t.length>1;)if(!(e=e[t.shift()]))return;return e[t.shift()]=n,n}for(let e in watchers)watchers.hasOwnProperty(e)&&(observe(e,watchers[e].bind(proxied)),get(proxied,e));function observe(e,t){signals[e]||(signals[e]=[]),signals[e].push(t)}function notify(e){options.t&&persist();const t=(e=Array.isArray(e)?e:e.split(".")).join(".");for(;e.length>0;){let t=e.join(".");if(!signals[t]||signals[t].length<1)return;signals[t].forEach(e=>e({i:get(cache,t),p:get(raw,t)})),e.pop()}"function"!=typeof get(raw,t)&&set(cache,t,get(proxied,t))}const frame=options.u||document,elemIDs=[],booleanAttributes=["async","autofocus","autoplay","checked","contenteditable","controls","default","defer","disabled","formnovalidate","frameborder","hidden","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","readonly","required","reversed","scoped","selected","typemustmatch"];function eID(e){let t;if(e.attributes._id)t=e.attributes._id.value;else{do{t=Math.random().toString(36).substr(2,9)}while(elemIDs.includes(t));e.setAttribute("_id",t),elemIDs.push(t)}return t}function parseDOM(e=frame){e===document&&(e=e.body);const t={};e.querySelectorAll("[\\:pre]").forEach(e=>{const n=eID(e);t[n]=e.outerHTML,e.outerHTML=`<span :pre _id="${n}"></span>`}),e.innerHTML=e.innerHTML.replace(/{{([^{}]+)}}/g,'<span :text="$1"></span>'),e.querySelectorAll("[\\:text]").forEach(e=>{const t=e.attributes[":text"].value.trim();e.textContent=get(proxied,t),e.attributes[":unbound"]||observe(t,()=>e.textContent=get(proxied,t))}),e.querySelectorAll("[\\:html]").forEach(e=>{const t=e.attributes[":html"].value.trim();e.innerHTML=get(proxied,t),parseDOM(e),e.attributes[":unbound"]||observe(t,()=>e.innerHTML=get(proxied,t))}),e.querySelectorAll("[\\:value]").forEach(e=>{const t=e.attributes[":value"].value.trim();let n=get(proxied,t);e.attributes.type&&["radio","checkbox"].includes(e.attributes.type.value.trim())?(e.checked=n||!1,e.attributes[":unbound"]||(observe(t,()=>{n=get(proxied,t),e.checked=n||!1}),e.onchange=e=>set(proxied,t,e.target.checked))):(e.value=n,e.attributes[":unbound"]||(observe(t,()=>e.value=get(proxied,t)),e.oninput=e=>set(proxied,t,e.target.value)))}),e.querySelectorAll("[\\:if]").forEach(t=>{const n=t.attributes[":if"].value.trim(),o=eID(t),r=t.outerHTML,c=t.attributes[":unbound"];function s(){t.outerHTML=get(proxied,n)?r:`<span _id="${o}"></span>`,t=e.querySelector(`[_id="${o}"]`)}s(),c||observe(n,s)}),e.querySelectorAll("[\\:else]").forEach(t=>{const n=t.attributes[":else"].value.trim(),o=eID(t),r=t.outerHTML,c=t.attributes[":unbound"];function s(){t.outerHTML=get(proxied,n)?`<span _id="${o}"></span>`:r,t=e.querySelector(`[_id="${o}"]`)}s(),c||observe(n,s)}),e.querySelectorAll("[\\:each]").forEach(e=>{const t=e.attributes[":each"].value.trim(),n=e.firstElementChild.cloneNode(!0);function o(){const o=get(proxied,t);if(o){e.innerHTML="";for(let t=0;t<o.length;t++){const r=n.cloneNode(!0);r.innerHTML=r.innerHTML.replace(/\[\[:each:id]]/g,t+1).replace(/\[\[:each:value:html]]/g,o[t]),parseDOM(r),r.innerHTML=r.innerHTML.replace(/\[\[:each:value]]/g,"<span :each:value></span>"),r.querySelectorAll("[\\:each\\:value]").forEach(e=>e.textContent=o[t]),e.appendChild(r)}}}o(),e.attributes[":unbound"]||observe(t,o)}),Array.from(e.getElementsByTagName("*")).filter(e=>{const t=Array.from(e.attributes);for(let e=0;e<t.length;e++)if(/^:bind:.+/.test(t[e].name))return!0;return!1}).forEach(e=>{const t={};Array.from(e.attributes).filter(e=>/^:bind:.+/.test(e.name)).forEach(n=>{const o=n.name.slice(6),r=n.value.trim().split(" ").map(e=>e.split(","));function c(){let n=r.map(e=>{const t=get(proxied,e[0]);return e[1]?t?e[1]:void 0:t}).filter(e=>![null,void 0].includes(e)).join(" ");return n?booleanAttributes.includes(o)?["false",!1].includes(n)?e.removeAttribute(o):e.setAttribute(o,!0):e.setAttribute(o,n):[null,void 0].includes(t[o])?void e.removeAttribute(o):e.setAttribute(o,t[o])}e.attributes[o]&&(t[o]=e.attributes[o].value),c(),e.attributes[":unbound"]||r.forEach(e=>observe(e[0],c))})}),e.querySelectorAll("[\\:pre]").forEach(e=>e.outerHTML=t[eID(e)])}return parseDOM(frame),proxied}
