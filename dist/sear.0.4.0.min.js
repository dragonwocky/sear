/*
 * Sear.js 0.4.0
 * (c) 2020 dragonwocky <thedragonring.bod@gmail.com>
 * (https://dragonwocky.me/) under the MIT License
 */

"use strict";class Sear{constructor(t){this.t=t.s||!1,this.i={...t.data,...this.o(t.s)},this.u=this.clone(this.i,["function",void 0]),this.h=class extends Array{constructor(t,e,r){super(...t),this.__proto__.path=e,this.__proto__.parent=r}l(t,...e){const r=Array.from(this),s=r[t](...e);return this.__proto__.parent.set(this.__proto__.parent.p,this.__proto__.path,r),s}copyWithin(...t){return this.l("copyWithin",...t)}fill(...t){return this.l("fill",...t)}pop(...t){return this.l("pop",...t)}push(...t){return this.l("push",...t)}reverse(...t){return this.l("reverse",...t)}sort(...t){return this.l("sort",...t)}shift(...t){return this.l("shift",...t)}unshift(...t){return this.l("unshift",...t)}splice(...t){return this.l("splice",...t)}},this.j={v:[null],m:{}},this.p=new Proxy(this.i,this.O()),this.A={},this.g=t.watch||{};for(let t in this.g)if(this.g.hasOwnProperty(t)){if("function"!=typeof this.g[t])throw new Error(`[Sear] Watchers must be functions! Offender: <${t}>`);this.observe(t,this.g[t].bind(this.p)),this.get(this.p,t)}return this.$=[],this.k=["async","autofocus","autoplay","checked","contenteditable","controls","default","defer","disabled","formnovalidate","frameborder","hidden","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","readonly","required","reversed","scoped","selected","typemustmatch"],document.addEventListener("DOMContentLoaded",()=>{this.S=t._||document.body,this.D()}),this.p}clone(t,e){let r;if(e&&typeof t===e[0])return e[1];if(null==t||"object"!=typeof t)return t;if(t instanceof Date)return r=new Date,r.setTime(t.getTime()),r;if(Array.isArray(t)){r=[];for(let s=0;s<t.length;s++)r[s]=this.clone(t[s],e);return r}if(t.constructor===Object){r={};for(let s in t)t.hasOwnProperty(s)&&(r[s]=this.clone(t[s],e));return r}throw new Error(`[Sear] <${t.constructor.name}> is an unsupported data type!\n\nSupported data types are: (Basic) Objects, Functions, Arrays, Dates, Strings, Numbers, and Booleans.\n`)}isEqual(t,e){const r=Object.prototype.toString.call(t);if(r!==Object.prototype.toString.call(e))return!1;if(["[object Array]","[object Object]"].indexOf(r)<0)return t==e;const s="[object Array]"===r?t.length:Object.keys(t).length;if(s!==("[object Array]"===r?e.length:Object.keys(e).length))return!1;function n(t,e){const r=Object.prototype.toString.call(t);if(["[object Array]","[object Object]"].indexOf(r)>=0){if(!this.isEqual(t,e))return!1}else{if(r!==Object.prototype.toString.call(e))return!1;if("[object Function]"===r){if(t.toString()!==e.toString())return!1}else if(t!==e)return!1}return!0}if("[object Array]"===r){for(let r=0;r<s;r++)if(!1===n(t[r],e[r]))return!1}else for(let r in t)if(t.hasOwnProperty(r)&&!1===n(t[r],e[r]))return!1;return!0}s(t,e){if(!t)return!1;const r=this.clone(e),s={};return Object.keys(r).filter(t=>"function"==typeof r[t]).forEach(t=>{s[t]=r[t].toString().trim(),delete r[t]}),localStorage[t]=JSON.stringify({data:r,F:s})}o(store){try{if(store=JSON.parse(localStorage[store]||"{}"),store&&"object"==typeof store)return store.data=store.data||{},store.F=store.F||{},Object.keys(store.F).forEach(key=>{try{eval(`store.computed[key] = (${store.F[key].startsWith("function")?"":"function"} ${store.F[key]})`)}catch(t){store.F[key]=new Function(`return (${store.F[key].startsWith("function")?"":"function"} ${store.F[key]})`)()}}),{...store.data,...store.F}}catch(t){return{}}}observe(t,e){this.A[t]||(this.A[t]=[]),this.A[t].push(e)}M(t){this.s(this.t,this.i);const e=(t=Array.isArray(t)?t:t.split(".")).join("."),r=this.get(this.i,e);for(;t.length>0;){let e=t.join(".");if(!this.A[e]||this.A[e].length<1)return;this.A[e].forEach(t=>t(this.clone(this.get("function"==typeof r?this.p:this.u,e)))),t.pop()}"function"!=typeof r&&this.set(this.u,e,this.clone(r))}O(t=[]){const e=this;return{get(r,s){if(!(s in r))return;const n=[...t,s].join("."),i=e.j.v[e.j.v.length-1];if("function"==typeof r[s]){i&&!e.j.m[i].includes(n)&&e.j.m[i].push(n),e.j.v.push(n),e.observe(n,()=>e.set(e.u,n,void 0)),e.get(e.u,n)||(e.j.m[n]=[],e.set(e.u,n,e.clone(r[s].call(e.p))));const t=e.get(e.u,n);return e.j.v.pop(),t}return i&&!e.j.m[i].includes(n)&&e.j.m[i].push(n),Array.isArray(r[s])?new e.h(r[s],[...t,s],e):"object"==typeof r[s]&&null!==r[s]?new Proxy(r[s],e.O([...t,s])):r[s]},set(r,s,n){if(e.isEqual(r[s],n))return!0;const i=[...t,s].join(".");return r[s]=n,Object.keys(e.j.m).forEach(t=>{e.j.m[t].includes(i)&&e.M(t)}),e.M([...t,s]),!0}}}N(t=[]){const e=this;return{get:(t,e)=>t[e],set:(r,s,n)=>!!e.isEqual(r[s],n)||(r[s]=n,e.M([...t]),!0)}}get(t,e){for(e=Array.isArray(e)?e:e.split(".");e.length>1;)if(!(t=t[e.shift()]))return;return t[e]}set(t,e,r){for(e=Array.isArray(e)?e:e.split(".");e.length>1;)if(!(t=t[e.shift()]))return;return t[e.shift()]=r,r}W(t){let e;if(t.attributes._id)e=t.attributes._id.value;else{do{e=Math.random().toString(36).substr(2,9)}while(this.$.includes(e));t.setAttribute("_id",e),this.$.push(e)}return e}D(t=this.S){t===document&&(t=t.body);const e=this,r={};t.querySelectorAll("[\\:pre]").forEach(t=>{const s=e.W(t);r[s]=t.outerHTML,t.outerHTML=`<span :pre _id="${s}"></span>`}),t.innerHTML=t.innerHTML.replace(/{{([^{}]+)}}/g,'<span :text="$1"></span>'),t.querySelectorAll("[\\:text]").forEach(t=>{const r=t.attributes[":text"].value.trim();t.textContent=e.get(e.p,r),t.attributes[":unbound"]||e.observe(r,()=>t.textContent=e.get(e.p,r))}),t.querySelectorAll("[\\:html]").forEach(t=>{const r=t.attributes[":html"].value.trim();t.innerHTML=e.get(e.p,r),e.D(t),t.attributes[":unbound"]||e.observe(r,()=>t.innerHTML=e.get(e.p,r))}),t.querySelectorAll("[\\:value]").forEach(t=>{const r=t.attributes[":value"].value.trim();let s=e.get(e.p,r);t.attributes.type&&["radio","checkbox"].includes(t.attributes.type.value.trim())?(t.checked=s||!1,t.attributes[":unbound"]||(e.observe(r,()=>{s=e.get(e.p,r),t.checked=s||!1}),t.onchange=t=>e.set(e.p,r,t.target.checked))):(t.value=s,t.attributes[":unbound"]||(e.observe(r,()=>t.value=e.get(e.p,r)),t.oninput=t=>e.set(e.p,r,t.target.value)))}),t.querySelectorAll("[\\:if]").forEach(r=>{const s=r.attributes[":if"].value.trim(),n=e.W(r),i=r.outerHTML,o=r.attributes[":unbound"];function c(){r.outerHTML=e.get(e.p,s)?i:`<span _id="${n}"></span>`,r=t.querySelector(`[_id="${n}"]`)}c(),o||e.observe(s,c)}),t.querySelectorAll("[\\:else]").forEach(r=>{const s=r.attributes[":else"].value.trim(),n=e.W(r),i=r.outerHTML,o=r.attributes[":unbound"];function c(){r.outerHTML=e.get(e.p,s)?`<span _id="${n}"></span>`:i,r=t.querySelector(`[_id="${n}"]`)}c(),o||e.observe(s,c)}),t.querySelectorAll("[\\:each]").forEach(t=>{const r=t.attributes[":each"].value.trim(),s=t.firstElementChild.cloneNode(!0);function n(){const n=e.get(e.p,r);if(n){t.innerHTML="";for(let r=0;r<n.length;r++){const i=s.cloneNode(!0);i.innerHTML=i.innerHTML.replace(/\[\[:each:id]]/g,r+1).replace(/\[\[:each:value:html]]/g,n[r]),e.D(i),i.innerHTML=i.innerHTML.replace(/\[\[:each:value]]/g,"<span :each:value></span>"),i.querySelectorAll("[\\:each\\:value]").forEach(t=>t.textContent=n[r]),t.appendChild(i)}}}n(),t.attributes[":unbound"]||e.observe(r,n)}),Array.from(t.getElementsByTagName("*")).filter(t=>{const e=Array.from(t.attributes);for(let t=0;t<e.length;t++)if(/^:bind:.+/.test(e[t].name))return!0;return!1}).forEach(t=>{const r={};Array.from(t.attributes).filter(t=>/^:bind:.+/.test(t.name)).forEach(s=>{const n=s.name.slice(6),i=s.value.trim().split(" ").map(t=>t.split(","));function o(){let s=i.map(t=>{const r=e.get(e.p,t[0]);return t[1]?r?t[1]:void 0:r}).filter(t=>![null,void 0].includes(t)).join(" ");return s?e.k.includes(n)?["false",!1].includes(s)?t.removeAttribute(n):t.setAttribute(n,!0):t.setAttribute(n,s):[null,void 0].includes(r[n])?void t.removeAttribute(n):t.setAttribute(n,r[n])}t.attributes[n]&&(r[n]=t.attributes[n].value),o(),t.attributes[":unbound"]||i.forEach(t=>e.observe(t[0],o))})}),t.querySelectorAll("[\\:pre]").forEach(t=>t.outerHTML=r[e.W(t)])}}
