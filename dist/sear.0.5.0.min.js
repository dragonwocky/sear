/*
 * Sear.js 0.5.0
 * (c) 2020 dragonwocky <thedragonring.bod@gmail.com>
 * (https://dragonwocky.me/) under the MIT License
 */

"use strict";class Sear{constructor(t){this.t={},t.format.version&&(this.t={version:t.format.version,i:t.format.i||function(){return{}}}),t.format.name&&(this.t.name=t.format.name),this.s=this.h(t.data,{o:this.u(this.t.name)}),this.l=this.clone(this.s,{p:()=>{}}),this.m=class extends Array{constructor(t,e,i){super(...t),this.__proto__.path=e,this.__proto__.parent=i;for(let t of["copyWithin","fill","pop","push","reverse","sort","shift","unshift","splice"])this[t]=(...e)=>this.j(t,...e)}j(t,...e){const i=Array.from(this),s=i[t](...e);return this.__proto__.parent.set(this.__proto__.parent.v,this.__proto__.path,i),s}},this.A={g:[null],O:{}},this.v=new Proxy(this.s,this.$());const e=(t,i=[])=>{Object.keys(t).forEach(s=>{if("object"==typeof t[s]&&!Array.isArray(t[s]))return e(t[s],[...i,s]);"function"==typeof t[s]&&this.get(this.v,[...i,s])})};e(this.s),this.S={},this.D=t.watch||{};for(let t in this.D){if("function"!=typeof this.D[t])throw new Error(`[Sear] Watchers must be functions! Offender: <${t}>`);this.observe(t,this.D[t].bind(this.v)),this.get(this.v,t)}return this._=[],this.k={},this.M=["async","autofocus","autoplay","checked","contenteditable","controls","default","defer","disabled","formnovalidate","frameborder","hidden","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","readonly","required","reversed","scoped","selected","typemustmatch"],document.addEventListener("DOMContentLoaded",()=>{if("el"in t){if("string"==typeof t.N&&t.N.startsWith("#")&&!t.N.includes(" ")&&(this.B=document.getElementById(t.N.slice(1)),!this.B))throw new Error(`[Sear] Element <${t.N}> does not exist!`);if(!this.B)throw new Error(`[Sear] Element <${t.N}> is invalid!\nElement must be passed as a single ID in a string (e.g. '#app').`)}else this.B=document.body;this.F()}),this.v}I(t,e){if(typeof t!=typeof e||Array.isArray(t)!=Array.isArray(e))return!1;if("object"==typeof t)if(Array.isArray(t)){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!this.I(t[i],e[i]))return!1}else{if(Object.keys(t).length!==Object.keys(e).length)return!1;for(let i in t)if(!this.I(t[i],e[i]))return!1}else if("function"==typeof t){if(t.toString()!==e.toString())return!1}else if(t!==e)return!1;return!0}h(...t){if(!t.length)return{};const e={},i=(t,s=[])=>{Object.keys(t).forEach(r=>{if("object"==typeof t[r]&&!Array.isArray(t[r]))return i(t[r],[...s,r]);this.set(e,[...s,r],t[r])})};return t.forEach(t=>i(this.clone(t))),e}clone(t,e){let i;if("object"==typeof e)for(let[i,s]of Object.entries(e))if(typeof t===i)return s(t);if(null===t||"object"!=typeof t)return t;if(t instanceof Date)return new Date((new Date).setTime(t.getTime()));if(Array.isArray(t)){i=[];for(let s=0;s<t.length;s++)i[s]=this.clone(t[s],e);return i}if(t.constructor===Object){i={};for(let s in t)i[s]=this.clone(t[s],e);return i}throw new Error(`[Sear] <${t.constructor.name}> is an unsupported data type!\n\nSupported data types are: (Basic) Objects, Functions, Arrays, Dates, Strings, Numbers, and Booleans.\n`)}J(t,e){if(!t)return!1;const i=this.clone(e).o,s={},r=(t,e=[])=>{Object.keys(t).filter(e=>"object"==typeof t[e]).forEach(i=>{this.set(s,[...e,i],{}),r(t[i],[...e,i])}),Object.keys(t).filter(e=>"function"==typeof t[e]).forEach(i=>{this.set(s,[...e,i],t[i]),delete t[i]})};r(i);const n={data:i,P:s};return"version"in this.t&&(n.version=this.t.version),localStorage[t]=JSON.stringify(n)}u(t){if(!t)return{};try{if((t=JSON.parse(localStorage[t]||"{}"))&&"object"==typeof t){t.data=t.data||{},t.P=t.P||{};const e=(i,s=[])=>{Object.keys(i).forEach(r=>"object"==typeof i[r]?e(i[r],[...s,r]):this.set(t.P,[...s,r],new Function(`return (${i[r].startsWith("function")?"":"function"} ${i[r]})`)()))};e(t.P);const i=this.h(t.data,t.P);return t.version!==this.t.version?this.t.i(i):i}}catch(t){return{}}}observe(t,e){this.S[t]||(this.S[t]=[]),this.S[t].push(e)}W(t){this.J(this.t.name,this.s);const e=(t=Array.isArray(t)?t:t.split(".")).join("."),i=this.get(this.s,e);for(;t.length;){let e=t.join(".");this.S[e]&&this.S[e].forEach(t=>{"function"==typeof this.get(this.s,e)&&this.set(this.l,e,void 0),t(this.clone(this.get(this.l,e)))}),t.pop()}return"function"!=typeof i&&this.set(this.l,e,this.clone(i)),!0}$(t=[]){const e=this;return{get(i,s){if(!(s in i))return;const r=[...t,s].join("."),n=e.A.g[e.A.g.length-1],h=e.A.O[n];return"function"==typeof i[s]?(n&&!h.includes(r)&&h.push(r),e.A.g.push(r),e.get(e.l,r)||(e.A.O[r]=[],e.set(e.l,r,e.clone(i[s].call(e.v)))),e.A.g.pop(),e.get(e.l,r)):(n&&!h.includes(r)&&h.push(r),Array.isArray(i[s])?new e.m(i[s],[...t,s],e):"object"==typeof i[s]&&null!==i[s]?new Proxy(i[s],e.$([...t,s])):i[s])},set:(i,s,r)=>!!e.I(i[s],r)||(i[s]=r,Object.keys(e.A.O).forEach(i=>{e.A.O[i].includes([...t,s].join("."))&&e.W(i)}),e.W([...t,s]),!0)}}get(t,e){for(e=Array.isArray(e)?e:e.split(".");e.length>1;)if(!(t=t[e.shift()]))return;return t[e]}set(t,e,i){for(e=Array.isArray(e)?e:e.split(".");e.length>1;){const i=e.shift();t[i]||(t[i]={}),t=t[i]}return t[e.shift()]=i,i}q(t){let e;if(t.attributes._id)e=t.attributes._id.value;else{do{e=Math.random().toString(36).substr(2,9)}while(this._.includes(e));t.setAttribute("_id",e),this._.push(e)}return e}C(t,e){if(t&&e)return{id:this.q(e),L(){return t.querySelector(`[_id="${this.id}"]`)}}}F(t=this.B){t===document&&(t=t.body),t.querySelectorAll("[\\:pre]").forEach(t=>{const e=this.q(t);this.k[e]||(this.k[e]=t.outerHTML,t.outerHTML=`<span :pre _id="${e}"></span>`)}),t.innerHTML=t.innerHTML.replace(/{{([^{}]+)}}/g,'<span :text="$1"></span>'),t.querySelectorAll("[\\:text]").forEach(e=>{const i=(e=this.C(t,e)).L().attributes[":text"].value.trim(),s=()=>{e.L()&&(e.L().textContent=this.get(this.v,i))};e.L().attributes[":unbound"]||this.observe(i,s),s()}),t.querySelectorAll("[\\:html]").forEach(e=>{const i=(e=this.C(t,e)).L().attributes[":html"].value.trim(),s=()=>{e.L()&&(e.L().innerHTML=this.get(this.v,i),this.F(e.L()))};e.L().attributes[":unbound"]||this.observe(i,s),s()}),t.querySelectorAll("[\\:value]").forEach(e=>{const i=(e=this.C(t,e)).L().attributes[":value"].value.trim(),s=()=>{e.L()&&(["radio","checkbox"].includes(e.L().type)?(e.L().checked=1==this.get(this.v,i),e.L().onchange=t=>this.set(this.v,i,t.target.checked)):(e.L().value=this.get(this.v,i),e.L().oninput=t=>this.set(this.v,i,t.target.value)))};e.L().attributes[":unbound"]||this.observe(i,s),s()}),t.querySelectorAll("[\\:each]").forEach(e=>{const i=(e=this.C(t,e)).L().attributes[":each"].value.trim(),s=e.L().firstElementChild.cloneNode(!0),r=()=>{if(!e.L())return;e.L().innerHTML="";const t=this.get(this.v,i);if(Array.isArray(t))for(let i=0;i<t.length;i++){const r=s.cloneNode(!0);r.innerHTML=r.innerHTML.replace(/\[\[:each:id]]/g,i+1).replace(/\[\[:each:value:html]]/g,t[i]),this.F(r),r.innerHTML=r.innerHTML.replace(/\[\[:each:value]]/g,"<span :each:value></span>"),r.querySelectorAll("[\\:each\\:value]").forEach(e=>e.textContent=t[i]),e.L().appendChild(r)}};e.L().attributes[":unbound"]||this.observe(i,r),r()}),Array.from(t.getElementsByTagName("*")).filter(t=>{const e=Array.from(t.attributes);for(let t=0;t<e.length;t++)if(/^:bind:.+/.test(e[t].name))return!0;return!1}).forEach(e=>{e=this.C(t,e);const i={};Array.from(e.L().attributes).filter(t=>/^:bind:.+/.test(t.name)).forEach(t=>{const s=t.name.slice(6),r=t.value.trim().split(" ").map(t=>t.split("="));e.L().attributes[s]&&(i[s]=e.L().attributes[s].value);const n=()=>{if(!e.L())return;let t=r.map(t=>{const e=this.get(this.v,t[0]);return t[1]?e?t[1]:void 0:e}).filter(t=>![null,void 0].includes(t)).join(" ");return""!==t?this.M.includes(s)?"false"===t.trim()?e.L().removeAttribute(s):e.L().setAttribute(s,!0):e.L().setAttribute(s,`${i[s]?i[s]:""} ${t}`):[null,void 0].includes(i[s])?void e.L().removeAttribute(s):e.L().setAttribute(s,i[s])};e.L().attributes[":unbound"]||r.forEach(t=>this.observe(t[0],n)),n()})}),t.querySelectorAll("[\\:if]").forEach(e=>{const i=(e=this.C(t,e)).L().attributes[":if"].value.trim(),s=e.L().outerHTML,r=()=>{if(!e.L())return;const t=this.get(this.v,i);e.L().outerHTML=(t.length?t.length:1==t)?s:`<span _id="${e.id}"></span>`,this.F(e.L())};e.L().attributes[":unbound"]||this.observe(i,r),r()}),t.querySelectorAll("[\\:else]").forEach(e=>{const i=(e=this.C(t,e)).L().attributes[":else"].value.trim(),s=e.L().outerHTML,r=()=>{if(!e.L())return;const t=this.get(this.v,i);e.L().outerHTML=(t.length?t.length:1==t)?`<span _id="${e.id}"></span>`:s,this.F(e.L())};e.L().attributes[":unbound"]||this.observe(i,r),r()}),t.querySelectorAll("[\\:pre]").forEach(t=>t.outerHTML=this.k[this.q(t)])}}
