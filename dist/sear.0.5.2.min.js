/*
 * Sear.js 0.5.2
 * (c) 2020 dragonwocky <thedragonring.bod@gmail.com>
 * (https://dragonwocky.me/) under the MIT License
 */

"use strict";class Sear{constructor(t){this.t={},t.format.version&&(this.t={version:t.format.version,handler:t.format.handler||function(){return{}}}),t.format.name&&(this.t.name=t.format.name),this.i=this.s(t.data,{h:this.o(this.t.name)}),this.u=this.clone(this.i,[["function",()=>{}]]),this.l=class extends Array{constructor(t,e,i){super(...t),this.__proto__.path=e,this.__proto__.parent=i;for(let t of["copyWithin","fill","pop","push","reverse","sort","shift","unshift","splice"])this[t]=(...e)=>this.p(t,...e)}p(t,...e){const i=Array.from(this),s=i[t](...e);return this.__proto__.parent.set(this.__proto__.parent.m,this.__proto__.path,i),s}},this.v={j:[null],A:{}},this.m=new Proxy(this.i,this.g());const e=(t,i=[])=>{Object.keys(t).forEach(s=>{if("object"==typeof t[s]&&!Array.isArray(t[s]))return e(t[s],[...i,s]);"function"==typeof t[s]&&this.get(this.m,[...i,s])})};e(this.i),this.O={},this.$=t.watch||{};for(let t in this.$){if("function"!=typeof this.$[t])throw new Error(`[Sear] Watchers must be functions! Offender: <${t}>`);this.observe(t,this.$[t].bind(this.m)),this.get(this.m,t)}return this.S=[],this.D={},this._=["async","autofocus","autoplay","checked","contenteditable","controls","default","defer","disabled","formnovalidate","frameborder","hidden","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","readonly","required","reversed","scoped","selected","typemustmatch"],document.addEventListener("DOMContentLoaded",()=>{if("el"in t){if("string"==typeof t.k&&t.k.startsWith("#")&&!t.k.includes(" ")&&(this.M=document.getElementById(t.k.slice(1)),!this.M))throw new Error(`[Sear] Element <${t.k}> does not exist!`);if(!this.M)throw new Error(`[Sear] Element <${t.k}> is invalid!\nElement must be passed as a single ID in a string (e.g. '#app').`)}else this.M=document.body;this.N()}),this.m}B(t,e){if(typeof t!=typeof e||Array.isArray(t)!=Array.isArray(e))return!1;if("object"==typeof t)if(Array.isArray(t)){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!this.B(t[i],e[i]))return!1}else{if(Object.keys(t).length!==Object.keys(e).length)return!1;for(let i in t)if(!this.B(t[i],e[i]))return!1}else if("function"==typeof t){if(t.toString()!==e.toString())return!1}else if(t!==e)return!1;return!0}s(...t){if(!t.length)return{};const e={},i=(t,s=[])=>{Object.keys(t).forEach(r=>{if("object"==typeof t[r]&&!Array.isArray(t[r]))return i(t[r],[...s,r]);this.set(e,[...s,r],t[r])})};return t.forEach(t=>i(this.clone(t))),e}clone(t,e){let i;if("object"==typeof e)for(let[i,s]of e)if(typeof t===i)return s(t);if(null===t||"object"!=typeof t)return t;if(t instanceof Date)return new Date((new Date).setTime(t.getTime()));if(Array.isArray(t)){i=[];for(let s=0;s<t.length;s++)i[s]=this.clone(t[s],e);return i}if(t.constructor===Object){i={};for(let s in t)i[s]=this.clone(t[s],e);return i}throw new Error(`[Sear] <${t.constructor.name}> is an unsupported data type!\n\nSupported data types are: (Basic) Objects, Functions, Arrays, Dates, Strings, Numbers, and Booleans.\n`)}F(t,e){if(!t)return!1;const i=this.clone(e).h,s={},r=(t,e=[])=>{Object.keys(t).filter(e=>"object"==typeof t[e]).forEach(i=>{this.set(s,[...e,i],{}),r(t[i],[...e,i])}),Object.keys(t).filter(e=>"function"==typeof t[e]).forEach(i=>{this.set(s,[...e,i],t[i]),delete t[i]})};r(i);const n={data:i,I:s};return"version"in this.t&&(n.version=this.t.version),localStorage[t]=JSON.stringify(n)}o(t){if(!t)return{};try{if((t=JSON.parse(localStorage[t]||"{}"))&&"object"==typeof t){t.data=t.data||{},t.I=t.I||{};const e=(i,s=[])=>{Object.keys(i).forEach(r=>"object"==typeof i[r]?e(i[r],[...s,r]):this.set(t.I,[...s,r],new Function(`return (${i[r].startsWith("function")?"":"function"} ${i[r]})`)()))};e(t.I);const i=this.s(t.data,t.I);return t.version!==this.t.version?this.t.handler(i):i}}catch(t){return{}}}observe(t,e){this.O[t]||(this.O[t]=[]),this.O[t].push(e)}J(t){this.F(this.t.name,this.i);const e=(t=Array.isArray(t)?t:t.split(".")).join("."),i=this.get(this.i,e);for(;t.length;){let e=t.join(".");this.O[e]&&this.O[e].forEach(t=>{"function"==typeof this.get(this.i,e)&&this.set(this.u,e,void 0),t(this.clone(this.get(this.u,e)))}),t.pop()}return"function"!=typeof i&&this.set(this.u,e,this.clone(i)),!0}g(t=[]){const e=this;return{get(i,s){if(!(s in i))return;const r=[...t,s].join("."),n=e.v.j[e.v.j.length-1],h=e.v.A[n];return"function"==typeof i[s]?(n&&!h.includes(r)&&h.push(r),e.v.j.push(r),e.get(e.u,r)||(e.v.A[r]=[],e.set(e.u,r,e.clone(i[s].call(e.m)))),e.v.j.pop(),e.get(e.u,r)):(n&&!h.includes(r)&&h.push(r),Array.isArray(i[s])?new e.l(i[s],[...t,s],e):"object"==typeof i[s]&&null!==i[s]?new Proxy(i[s],e.g([...t,s])):i[s])},set:(i,s,r)=>!!e.B(i[s],r)||(i[s]=r,Object.keys(e.v.A).forEach(i=>{e.v.A[i].includes([...t,s].join("."))&&e.J(i)}),e.J([...t,s]),!0)}}get(t,e){for(e=Array.isArray(e)?e:e.split(".");e.length>1;)if(!(t=t[e.shift()]))return;return t[e]}set(t,e,i){for(e=Array.isArray(e)?e:e.split(".");e.length>1;){const i=e.shift();t[i]||(t[i]={}),t=t[i]}return t[e.shift()]=i,i}P(t){let e;if(t.attributes._id)e=t.attributes._id.value;else{do{e=Math.random().toString(36).substr(2,9)}while(this.S.includes(e));t.setAttribute("_id",e),this.S.push(e)}return e}W(t,e){if(t&&e)return{id:this.P(e),q(){return t.querySelector(`[_id="${this.id}"]`)}}}N(t=this.M){t===document&&(t=t.body),t.querySelectorAll("[\\:pre]").forEach(t=>{const e=this.P(t);this.D[e]||(this.D[e]=t.outerHTML,t.outerHTML=`<span :pre _id="${e}"></span>`)}),t.innerHTML=t.innerHTML.replace(/{{([^{}]+)}}/g,'<span :text="$1"></span>'),t.querySelectorAll("[\\:text]").forEach(e=>{const i=(e=this.W(t,e)).q().attributes[":text"].value.trim(),s=()=>{e.q()&&(e.q().textContent=this.get(this.m,i))};e.q().attributes[":unbound"]||this.observe(i,s),s()}),t.querySelectorAll("[\\:html]").forEach(e=>{const i=(e=this.W(t,e)).q().attributes[":html"].value.trim(),s=()=>{e.q()&&(e.q().innerHTML=this.get(this.m,i),this.N(e.q()))};e.q().attributes[":unbound"]||this.observe(i,s),s()}),t.querySelectorAll("[\\:value]").forEach(e=>{const i=(e=this.W(t,e)).q().attributes[":value"].value.trim(),s=()=>{e.q()&&(["radio","checkbox"].includes(e.q().type)?(e.q().checked=1==this.get(this.m,i),e.q().onchange=t=>this.set(this.m,i,t.target.checked)):(e.q().value=this.get(this.m,i),e.q().oninput=t=>this.set(this.m,i,t.target.value)))};e.q().attributes[":unbound"]||this.observe(i,s),s()}),t.querySelectorAll("[\\:each]").forEach(e=>{const i=(e=this.W(t,e)).q().attributes[":each"].value.trim(),s=e.q().firstElementChild.cloneNode(!0),r=()=>{if(!e.q())return;e.q().innerHTML="";const t=this.get(this.m,i);if(Array.isArray(t))for(let i=0;i<t.length;i++){const r=s.cloneNode(!0);r.innerHTML=r.innerHTML.replace(/\[\[:each:id]]/g,i+1).replace(/\[\[:each:value:html]]/g,t[i]),this.N(r),r.innerHTML=r.innerHTML.replace(/\[\[:each:value]]/g,"<span :each:value></span>"),r.querySelectorAll("[\\:each\\:value]").forEach(e=>e.textContent=t[i]),e.q().appendChild(r)}};e.q().attributes[":unbound"]||this.observe(i,r),r()}),Array.from(t.getElementsByTagName("*")).filter(t=>{const e=Array.from(t.attributes);for(let t=0;t<e.length;t++)if(/^:bind:.+/.test(e[t].name))return!0;return!1}).forEach(e=>{e=this.W(t,e);const i={};Array.from(e.q().attributes).filter(t=>/^:bind:.+/.test(t.name)).forEach(t=>{const s=t.name.slice(6),r=t.value.trim().split(" ").map(t=>t.split("="));e.q().attributes[s]&&(i[s]=e.q().attributes[s].value);const n=()=>{if(!e.q())return;let t=r.map(t=>{const e=this.get(this.m,t[0]);return t[1]?e?t[1]:void 0:e}).filter(t=>![null,void 0].includes(t)).join(" ");return""!==t?this._.includes(s)?"false"===t.trim()?e.q().removeAttribute(s):e.q().setAttribute(s,!0):e.q().setAttribute(s,`${i[s]?i[s]:""} ${t}`):[null,void 0].includes(i[s])?void e.q().removeAttribute(s):e.q().setAttribute(s,i[s])};e.q().attributes[":unbound"]||r.forEach(t=>this.observe(t[0],n)),n()})}),t.querySelectorAll("[\\:if]").forEach(e=>{const i=(e=this.W(t,e)).q().attributes[":if"].value.trim(),s=e.q().outerHTML,r=()=>{const t=this.get(this.m,i);e.q()&&(e.q().outerHTML=(t.length?t.length:1==t)?s:`<span _id="${e.id}"></span>`,this.N(e.q()))};e.q().attributes[":unbound"]||this.observe(i,r),r()}),t.querySelectorAll("[\\:else]").forEach(e=>{const i=(e=this.W(t,e)).q().attributes[":else"].value.trim(),s=e.q().outerHTML,r=()=>{const t=this.get(this.m,i);e.q()&&(e.q().outerHTML=(t.length?t.length:1==t)?`<span _id="${e.id}"></span>`:s,this.N(e.q()))};e.q().attributes[":unbound"]||this.observe(i,r),r()}),t.querySelectorAll("[\\:pre]").forEach(t=>t.outerHTML=this.D[this.P(t)])}}
