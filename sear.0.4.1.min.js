/*
 * Sear.js v0.4
 * (c) 2020 dragonwocky <thedragonring.bod@gmail.com>
 * (https://dragonwocky.me/) under the MIT License
 */
"use strict";class Sear{constructor(t){this._store=t.persist||!1,"object"==typeof t.format&&(this._format={version:t.format.version,handler:t.format.handler||function(){return{}}}),this._raw=this.deepmerge(t.data,this.retrieve(t.persist)),this._cache=this.clone(this._raw,["function",void 0]),this.ObservableArray=class extends Array{constructor(t,e,r){super(...t),this.__proto__.path=e,this.__proto__.parent=r}_update(t,...e){const r=Array.from(this),s=r[t](...e);return this.__proto__.parent.set(this.__proto__.parent._proxied,this.__proto__.path,r),s}copyWithin(...t){return this._update("copyWithin",...t)}fill(...t){return this._update("fill",...t)}pop(...t){return this._update("pop",...t)}push(...t){return this._update("push",...t)}reverse(...t){return this._update("reverse",...t)}sort(...t){return this._update("sort",...t)}shift(...t){return this._update("shift",...t)}unshift(...t){return this._update("unshift",...t)}splice(...t){return this._update("splice",...t)}},this._dependency={targets:[null],tracking:{}},this._proxied=new Proxy(this._raw,this.trapper());const e=(t,r=[])=>{Object.keys(t).forEach(s=>{if("object"==typeof t[s]&&!Array.isArray(t[s]))return e(t[s],[...r,s]);"function"==typeof t[s]&&this.get(this._proxied,[...r,s])})};e(this._raw),this._signals={},this._watchers=t.watch||{};for(let t in this._watchers)if(this._watchers.hasOwnProperty(t)){if("function"!=typeof this._watchers[t])throw new Error(`[Sear] Watchers must be functions! Offender: <${t}>`);this.observe(t,this._watchers[t].bind(this._proxied)),this.get(this._proxied,t)}return this._elemIDs=[],this.booleanAttributes=["async","autofocus","autoplay","checked","contenteditable","controls","default","defer","disabled","formnovalidate","frameborder","hidden","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","readonly","required","reversed","scoped","selected","typemustmatch"],document.addEventListener("DOMContentLoaded",()=>{this._frame=t.el||document.body,this.parseDOM()}),this._proxied}deepmerge(...t){if(!t.length)return{};const e={},r=(t,s=[])=>{Object.keys(t).forEach(n=>{if("object"==typeof t[n]&&!Array.isArray(t[n]))return r(t[n],[...s,n]);this.set(e,[...s,n],t[n])})};return t.forEach(t=>r(t)),e}clone(t,e){let r;if(e&&typeof t===e[0])return e[1];if(null==t||"object"!=typeof t)return t;if(t instanceof Date)return(r=new Date).setTime(t.getTime()),r;if(Array.isArray(t)){r=[];for(let s=0;s<t.length;s++)r[s]=this.clone(t[s],e);return r}if(t.constructor===Object){r={};for(let s in t)t.hasOwnProperty(s)&&(r[s]=this.clone(t[s],e));return r}throw new Error(`[Sear] <${t.constructor.name}> is an unsupported data type!\n\nSupported data types are: (Basic) Objects, Functions, Arrays, Dates, Strings, Numbers, and Booleans.\n`)}isEqual(t,e){const r=Object.prototype.toString.call(t);if(r!==Object.prototype.toString.call(e))return!1;if(["[object Array]","[object Object]"].indexOf(r)<0)return t==e;const s="[object Array]"===r?t.length:Object.keys(t).length;if(s!==("[object Array]"===r?e.length:Object.keys(e).length))return!1;function n(t,e){const r=Object.prototype.toString.call(t);if(["[object Array]","[object Object]"].indexOf(r)>=0){if(!this.isEqual(t,e))return!1}else{if(r!==Object.prototype.toString.call(e))return!1;if("[object Function]"===r){if(t.toString()!==e.toString())return!1}else if(t!==e)return!1}return!0}if("[object Array]"===r){for(let r=0;r<s;r++)if(!1===n(t[r],e[r]))return!1}else for(let r in t)if(t.hasOwnProperty(r)&&!1===n(t[r],e[r]))return!1;return!0}persist(t,e){if(!t)return!1;const r=this.clone(e),s={},n=(t,e=[])=>{Object.keys(t).filter(e=>"object"==typeof t[e]).forEach(r=>{this.set(s,[...e,r],{}),n(t[r],[...e,r])}),Object.keys(t).filter(e=>"function"==typeof t[e]).forEach(r=>{this.set(s,[...e,r],t[r].toString().trim()),delete t[r]})};n(r);const o={data:r,computed:s};return"_format"in this&&(o.version=this._format.version),localStorage[t]=JSON.stringify(o)}retrieve(store){if(!store)return{};try{if(store=JSON.parse(localStorage[store]||"{}"),store&&"object"==typeof store){store.data=store.data||{},store.computed=store.computed||{};const process=(obj,path=[])=>{Object.keys(obj).forEach(key=>{if("object"==typeof obj[key])return process(obj[key],[...path,key]);try{return eval(`this.set(store.computed, [...path, key], (${obj[key].startsWith("function")?"":"function"} ${obj[key]})`)}catch(t){return this.set(store.computed,[...path,key],new Function(`return (${obj[key].startsWith("function")?"":"function"} ${obj[key]})`)())}})};process(store.computed);const parsed=this.deepmerge(store.data,store.computed);return"_format"in this&&store.version!==this._format.version?this._format.handler(parsed):parsed}}catch(t){return{}}}observe(t,e){this._signals[t]||(this._signals[t]=[]),this._signals[t].push(e)}notify(t){this.persist(this._store,this._raw);const e=(t=Array.isArray(t)?t:t.split(".")).join("."),r=this.get(this._raw,e);for(;t.length;){let e=t.join(".");this._signals[e]&&this._signals[e].forEach(t=>{const r=this.clone(this.get(this._cache,e));"function"==typeof r&&this.set(this._cache,e,void 0),t(r)}),t.pop()}return"function"!=typeof r&&this.set(this._cache,e,this.clone(r)),!0}trapper(t=[]){const e=this;return{get(r,s){if(!(s in r))return;const n=[...t,s].join("."),o=e._dependency.targets[e._dependency.targets.length-1];if("function"==typeof r[s]){o&&!e._dependency.tracking[o].includes(n)&&e._dependency.tracking[o].push(n),e._dependency.targets.push(n),e.get(e._cache,n)||(e._dependency.tracking[n]=[],e.set(e._cache,n,e.clone(r[s].call(e._proxied))));const t=e.get(e._cache,n);return e._dependency.targets.pop(),t}return o&&!e._dependency.tracking[o].includes(n)&&e._dependency.tracking[o].push(n),Array.isArray(r[s])?new e.ObservableArray(r[s],[...t,s],e):"object"==typeof r[s]&&null!==r[s]?new Proxy(r[s],e.trapper([...t,s])):r[s]},set(r,s,n){if(e.isEqual(r[s],n))return!0;const o=[...t,s].join(".");return r[s]=n,Object.keys(e._dependency.tracking).forEach(t=>{e._dependency.tracking[t].includes(o)&&e.notify(t)}),e.notify([...t,s]),!0}}}arraytrapper(t=[]){const e=this;return{get:(t,e)=>t[e],set:(r,s,n)=>!!e.isEqual(r[s],n)||(r[s]=n,e.notify([...t]),!0)}}get(t,e){for(e=Array.isArray(e)?e:e.split(".");e.length>1;)if(!(t=t[e.shift()]))return;return t[e]}set(t,e,r){for(e=Array.isArray(e)?e:e.split(".");e.length>1;){const r=e.shift();t[r]||(t[r]={}),t=t[r]}return t[e.shift()]=r,r}eID(t){let e;if(t.attributes._id)e=t.attributes._id.value;else{do{e=Math.random().toString(36).substr(2,9)}while(this._elemIDs.includes(e));t.setAttribute("_id",e),this._elemIDs.push(e)}return e}parseDOM(t=this._frame){t===document&&(t=t.body);const e=this,r={};t.querySelectorAll("[\\:pre]").forEach(t=>{const s=e.eID(t);r[s]=t.outerHTML,t.outerHTML=`<span :pre _id="${s}"></span>`}),t.innerHTML=t.innerHTML.replace(/{{([^{}]+)}}/g,'<span :text="$1"></span>'),t.querySelectorAll("[\\:text]").forEach(t=>{const r=t.attributes[":text"].value.trim();t.textContent=e.get(e._proxied,r),t.attributes[":unbound"]||e.observe(r,()=>t.textContent=e.get(e._proxied,r))}),t.querySelectorAll("[\\:html]").forEach(t=>{const r=t.attributes[":html"].value.trim();t.innerHTML=e.get(e._proxied,r),e.parseDOM(t),t.attributes[":unbound"]||e.observe(r,()=>t.innerHTML=e.get(e._proxied,r))}),t.querySelectorAll("[\\:value]").forEach(t=>{const r=t.attributes[":value"].value.trim();let s=e.get(e._proxied,r);t.attributes.type&&["radio","checkbox"].includes(t.attributes.type.value.trim())?(t.checked=s||!1,t.attributes[":unbound"]||(e.observe(r,()=>{s=e.get(e._proxied,r),t.checked=s||!1}),t.onchange=t=>e.set(e._proxied,r,t.target.checked))):(t.value=s,t.attributes[":unbound"]||(e.observe(r,()=>t.value=e.get(e._proxied,r)),t.oninput=t=>e.set(e._proxied,r,t.target.value)))}),t.querySelectorAll("[\\:if]").forEach(r=>{const s=r.attributes[":if"].value.trim(),n=e.eID(r),o=r.outerHTML,i=r.attributes[":unbound"];function a(){r.outerHTML=e.get(e._proxied,s)?o:`<span _id="${n}"></span>`,r=t.querySelector(`[_id="${n}"]`)}a(),i||e.observe(s,a)}),t.querySelectorAll("[\\:else]").forEach(r=>{const s=r.attributes[":else"].value.trim(),n=e.eID(r),o=r.outerHTML,i=r.attributes[":unbound"];function a(){r.outerHTML=e.get(e._proxied,s)?`<span _id="${n}"></span>`:o,r=t.querySelector(`[_id="${n}"]`)}a(),i||e.observe(s,a)}),t.querySelectorAll("[\\:each]").forEach(t=>{const r=t.attributes[":each"].value.trim(),s=t.firstElementChild.cloneNode(!0);function n(){const n=e.get(e._proxied,r);if(n){t.innerHTML="";for(let r=0;r<n.length;r++){const o=s.cloneNode(!0);o.innerHTML=o.innerHTML.replace(/\[\[:each:id]]/g,r+1).replace(/\[\[:each:value:html]]/g,n[r]),e.parseDOM(o),o.innerHTML=o.innerHTML.replace(/\[\[:each:value]]/g,"<span :each:value></span>"),o.querySelectorAll("[\\:each\\:value]").forEach(t=>t.textContent=n[r]),t.appendChild(o)}}}n(),t.attributes[":unbound"]||e.observe(r,n)}),Array.from(t.getElementsByTagName("*")).filter(t=>{const e=Array.from(t.attributes);for(let t=0;t<e.length;t++)if(/^:bind:.+/.test(e[t].name))return!0;return!1}).forEach(t=>{const r={};Array.from(t.attributes).filter(t=>/^:bind:.+/.test(t.name)).forEach(s=>{const n=s.name.slice(6),o=s.value.trim().split(" ").map(t=>t.split(","));function i(){let s=o.map(t=>{const r=e.get(e._proxied,t[0]);return t[1]?r?t[1]:void 0:r}).filter(t=>![null,void 0].includes(t)).join(" ");return s?e.booleanAttributes.includes(n)?["false",!1].includes(s)?t.removeAttribute(n):t.setAttribute(n,!0):t.setAttribute(n,s):[null,void 0].includes(r[n])?void t.removeAttribute(n):t.setAttribute(n,r[n])}t.attributes[n]&&(r[n]=t.attributes[n].value),i(),t.attributes[":unbound"]||o.forEach(t=>e.observe(t[0],i))})}),t.querySelectorAll("[\\:pre]").forEach(t=>t.outerHTML=r[e.eID(t)])}}