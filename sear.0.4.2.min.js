/*
 * Sear.js v0.4.2
 * (c) 2020 dragonwocky <thedragonring.bod@gmail.com>
 * (https://dragonwocky.me/) under the MIT License
 */
"use strict";class Sear{constructor(e){this._store=e.persist||!1,"object"==typeof e.format&&(this._format={version:e.format.version,handler:e.format.handler||function(){return{}}}),this._raw=this.deepmerge(e.data,this.retrieve(e.persist)),this._cache=this.clone(this._raw,["function",void 0]),this.ObservableArray=class extends Array{constructor(e,t,r){super(...e),this.__proto__.path=t,this.__proto__.parent=r}_update(e,...t){const r=Array.from(this),s=r[e](...t);return this.__proto__.parent.set(this.__proto__.parent._proxied,this.__proto__.path,r),s}copyWithin(...e){return this._update("copyWithin",...e)}fill(...e){return this._update("fill",...e)}pop(...e){return this._update("pop",...e)}push(...e){return this._update("push",...e)}reverse(...e){return this._update("reverse",...e)}sort(...e){return this._update("sort",...e)}shift(...e){return this._update("shift",...e)}unshift(...e){return this._update("unshift",...e)}splice(...e){return this._update("splice",...e)}},this._dependency={targets:[null],tracking:{}},this._proxied=new Proxy(this._raw,this.trapper());const t=(e,r=[])=>{Object.keys(e).forEach(s=>{if("object"==typeof e[s]&&!Array.isArray(e[s]))return t(e[s],[...r,s]);"function"==typeof e[s]&&this.get(this._proxied,[...r,s])})};t(this._raw),this._signals={},this._watchers=e.watch||{};for(let e in this._watchers)if(this._watchers.hasOwnProperty(e)){if("function"!=typeof this._watchers[e])throw new Error(`[Sear] Watchers must be functions! Offender: <${e}>`);this.observe(e,this._watchers[e].bind(this._proxied)),this.get(this._proxied,e)}return this._elemIDs=[],this.booleanAttributes=["async","autofocus","autoplay","checked","contenteditable","controls","default","defer","disabled","formnovalidate","frameborder","hidden","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","readonly","required","reversed","scoped","selected","typemustmatch"],document.addEventListener("DOMContentLoaded",()=>{if("el"in e){if("string"==typeof e.el&&e.el.startsWith("#")&&!e.el.includes(" ")&&(this._frame=document.getElementById(e.el.slice(1)),!this._frame))throw new Error(`[Sear] Element <${e.el}> does not exist!`);if(!this._frame)throw new Error(`[Sear] Element <${e.el}> is invalid!\nElement must be passed as a single ID in a string (e.g. '#app').`)}else this._frame=document.body;this.parseDOM()}),this._proxied}deepmerge(...e){if(!e.length)return{};const t={},r=(e,s=[])=>{Object.keys(e).forEach(n=>{if("object"==typeof e[n]&&!Array.isArray(e[n]))return r(e[n],[...s,n]);this.set(t,[...s,n],e[n])})};return e.forEach(e=>r(e)),t}clone(e,t){let r;if(t&&typeof e===t[0])return t[1];if(null==e||"object"!=typeof e)return e;if(e instanceof Date)return(r=new Date).setTime(e.getTime()),r;if(Array.isArray(e)){r=[];for(let s=0;s<e.length;s++)r[s]=this.clone(e[s],t);return r}if(e.constructor===Object){r={};for(let s in e)e.hasOwnProperty(s)&&(r[s]=this.clone(e[s],t));return r}throw new Error(`[Sear] <${e.constructor.name}> is an unsupported data type!\n\nSupported data types are: (Basic) Objects, Functions, Arrays, Dates, Strings, Numbers, and Booleans.\n`)}isEqual(e,t){const r=Object.prototype.toString.call(e);if(r!==Object.prototype.toString.call(t))return!1;if(["[object Array]","[object Object]"].indexOf(r)<0)return e==t;const s="[object Array]"===r?e.length:Object.keys(e).length;if(s!==("[object Array]"===r?t.length:Object.keys(t).length))return!1;function n(e,t){const r=Object.prototype.toString.call(e);if(["[object Array]","[object Object]"].indexOf(r)>=0){if(!this.isEqual(e,t))return!1}else{if(r!==Object.prototype.toString.call(t))return!1;if("[object Function]"===r){if(e.toString()!==t.toString())return!1}else if(e!==t)return!1}return!0}if("[object Array]"===r){for(let r=0;r<s;r++)if(!1===n(e[r],t[r]))return!1}else for(let r in e)if(e.hasOwnProperty(r)&&!1===n(e[r],t[r]))return!1;return!0}persist(e,t){if(!e)return!1;const r=this.clone(t),s={},n=(e,t=[])=>{Object.keys(e).filter(t=>"object"==typeof e[t]).forEach(r=>{this.set(s,[...t,r],{}),n(e[r],[...t,r])}),Object.keys(e).filter(t=>"function"==typeof e[t]).forEach(r=>{this.set(s,[...t,r],e[r].toString().trim()),delete e[r]})};n(r);const i={data:r,computed:s};return"_format"in this&&(i.version=this._format.version),localStorage[e]=JSON.stringify(i)}retrieve(store){if(!store)return{};try{if(store=JSON.parse(localStorage[store]||"{}"),store&&"object"==typeof store){store.data=store.data||{},store.computed=store.computed||{};const process=(obj,path=[])=>{Object.keys(obj).forEach(key=>{if("object"==typeof obj[key])return process(obj[key],[...path,key]);try{return eval(`this.set(store.computed, [...path, key], (${obj[key].startsWith("function")?"":"function"} ${obj[key]})`)}catch(e){return this.set(store.computed,[...path,key],new Function(`return (${obj[key].startsWith("function")?"":"function"} ${obj[key]})`)())}})};process(store.computed);const parsed=this.deepmerge(store.data,store.computed);return"_format"in this&&store.version!==this._format.version?this._format.handler(parsed):parsed}}catch(e){return{}}}observe(e,t){this._signals[e]||(this._signals[e]=[]),this._signals[e].push(t)}notify(e){this.persist(this._store,this._raw);const t=(e=Array.isArray(e)?e:e.split(".")).join("."),r=this.get(this._raw,t);for(;e.length;){let t=e.join(".");this._signals[t]&&this._signals[t].forEach(e=>{const r=this.clone(this.get(this._cache,t));"function"==typeof r&&this.set(this._cache,t,void 0),e(r)}),e.pop()}return"function"!=typeof r&&this.set(this._cache,t,this.clone(r)),!0}trapper(e=[]){const t=this;return{get(r,s){if(!(s in r))return;const n=[...e,s].join("."),i=t._dependency.targets[t._dependency.targets.length-1];if("function"==typeof r[s]){i&&!t._dependency.tracking[i].includes(n)&&t._dependency.tracking[i].push(n),t._dependency.targets.push(n),t.get(t._cache,n)||(t._dependency.tracking[n]=[],t.set(t._cache,n,t.clone(r[s].call(t._proxied))));const e=t.get(t._cache,n);return t._dependency.targets.pop(),e}return i&&!t._dependency.tracking[i].includes(n)&&t._dependency.tracking[i].push(n),Array.isArray(r[s])?new t.ObservableArray(r[s],[...e,s],t):"object"==typeof r[s]&&null!==r[s]?new Proxy(r[s],t.trapper([...e,s])):r[s]},set(r,s,n){if(t.isEqual(r[s],n))return!0;const i=[...e,s].join(".");return r[s]=n,Object.keys(t._dependency.tracking).forEach(e=>{t._dependency.tracking[e].includes(i)&&t.notify(e)}),t.notify([...e,s]),!0}}}arraytrapper(e=[]){const t=this;return{get:(e,t)=>e[t],set:(r,s,n)=>!!t.isEqual(r[s],n)||(r[s]=n,t.notify([...e]),!0)}}get(e,t){for(t=Array.isArray(t)?t:t.split(".");t.length>1;)if(!(e=e[t.shift()]))return;return e[t]}set(e,t,r){for(t=Array.isArray(t)?t:t.split(".");t.length>1;){const r=t.shift();e[r]||(e[r]={}),e=e[r]}return e[t.shift()]=r,r}eID(e){let t;if(e.attributes._id)t=e.attributes._id.value;else{do{t=Math.random().toString(36).substr(2,9)}while(this._elemIDs.includes(t));e.setAttribute("_id",t),this._elemIDs.push(t)}return t}parseDOM(e=this._frame){e===document&&(e=e.body);const t=this,r={};e.querySelectorAll("[\\:pre]").forEach(e=>{const s=t.eID(e);r[s]=e.outerHTML,e.outerHTML=`<span :pre _id="${s}"></span>`}),e.innerHTML=e.innerHTML.replace(/{{([^{}]+)}}/g,'<span :text="$1"></span>'),e.querySelectorAll("[\\:text]").forEach(e=>{const r=e.attributes[":text"].value.trim();e.textContent=t.get(t._proxied,r),e.attributes[":unbound"]||t.observe(r,()=>e.textContent=t.get(t._proxied,r))}),e.querySelectorAll("[\\:html]").forEach(e=>{const r=e.attributes[":html"].value.trim();e.innerHTML=t.get(t._proxied,r),t.parseDOM(e),e.attributes[":unbound"]||t.observe(r,()=>e.innerHTML=t.get(t._proxied,r))}),e.querySelectorAll("[\\:value]").forEach(e=>{const r=e.attributes[":value"].value.trim();let s=t.get(t._proxied,r);e.attributes.type&&["radio","checkbox"].includes(e.attributes.type.value.trim())?(e.checked=s||!1,e.attributes[":unbound"]||(t.observe(r,()=>{s=t.get(t._proxied,r),e.checked=s||!1}),e.onchange=e=>t.set(t._proxied,r,e.target.checked))):(e.value=s,e.attributes[":unbound"]||(t.observe(r,()=>e.value=t.get(t._proxied,r)),e.oninput=e=>t.set(t._proxied,r,e.target.value)))}),e.querySelectorAll("[\\:if]").forEach(r=>{const s=r.attributes[":if"].value.trim(),n=t.eID(r),i=r.outerHTML,o=r.attributes[":unbound"];function a(){r.outerHTML=t.get(t._proxied,s)?i:`<span _id="${n}"></span>`,r=e.querySelector(`[_id="${n}"]`)}a(),o||t.observe(s,a)}),e.querySelectorAll("[\\:else]").forEach(r=>{const s=r.attributes[":else"].value.trim(),n=t.eID(r),i=r.outerHTML,o=r.attributes[":unbound"];function a(){r.outerHTML=t.get(t._proxied,s)?`<span _id="${n}"></span>`:i,r=e.querySelector(`[_id="${n}"]`)}a(),o||t.observe(s,a)}),e.querySelectorAll("[\\:each]").forEach(e=>{const r=e.attributes[":each"].value.trim(),s=e.firstElementChild.cloneNode(!0);function n(){const n=t.get(t._proxied,r);if(n){e.innerHTML="";for(let r=0;r<n.length;r++){const i=s.cloneNode(!0);i.innerHTML=i.innerHTML.replace(/\[\[:each:id]]/g,r+1).replace(/\[\[:each:value:html]]/g,n[r]),t.parseDOM(i),i.innerHTML=i.innerHTML.replace(/\[\[:each:value]]/g,"<span :each:value></span>"),i.querySelectorAll("[\\:each\\:value]").forEach(e=>e.textContent=n[r]),e.appendChild(i)}}}n(),e.attributes[":unbound"]||t.observe(r,n)}),Array.from(e.getElementsByTagName("*")).filter(e=>{const t=Array.from(e.attributes);for(let e=0;e<t.length;e++)if(/^:bind:.+/.test(t[e].name))return!0;return!1}).forEach(e=>{const r={};Array.from(e.attributes).filter(e=>/^:bind:.+/.test(e.name)).forEach(s=>{const n=s.name.slice(6),i=s.value.trim().split(" ").map(e=>e.split(","));function o(){let s=i.map(e=>{const r=t.get(t._proxied,e[0]);return e[1]?r?e[1]:void 0:r}).filter(e=>![null,void 0].includes(e)).join(" ");return s?t.booleanAttributes.includes(n)?["false",!1].includes(s)?e.removeAttribute(n):e.setAttribute(n,!0):e.setAttribute(n,s):[null,void 0].includes(r[n])?void e.removeAttribute(n):e.setAttribute(n,r[n])}e.attributes[n]&&(r[n]=e.attributes[n].value),o(),e.attributes[":unbound"]||i.forEach(e=>t.observe(e[0],o))})}),e.querySelectorAll("[\\:pre]").forEach(e=>e.outerHTML=r[t.eID(e)])}}