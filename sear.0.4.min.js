/*
 * Sear.js v0.4
 * (c) 2020 dragonwocky <thedragonring.bod@gmail.com>
 * (https://dragonwocky.me/) under the MIT License
 */
"use strict";class Sear{constructor(e){this._store=e.persist||!1,this._raw={...e.data,...this.retrieve(e.persist)},this._cache=this.clone(this._raw,["function",void 0]),this.ObservableArray=class extends Array{constructor(e,t,r){super(...e),this.__proto__.path=t,this.__proto__.parent=r}_update(e,...t){const r=Array.from(this),n=r[e](...t);return this.__proto__.parent.set(this.__proto__.parent._proxied,this.__proto__.path,r),n}copyWithin(...e){return this._update("copyWithin",...e)}fill(...e){return this._update("fill",...e)}pop(...e){return this._update("pop",...e)}push(...e){return this._update("push",...e)}reverse(...e){return this._update("reverse",...e)}sort(...e){return this._update("sort",...e)}shift(...e){return this._update("shift",...e)}unshift(...e){return this._update("unshift",...e)}splice(...e){return this._update("splice",...e)}},this._dependency={targets:[null],tracking:{}},this._proxied=new Proxy(this._raw,this.trapper()),this._signals={},this._watchers=e.watch||{};for(let e in this._watchers)if(this._watchers.hasOwnProperty(e)){if("function"!=typeof this._watchers[e])throw new Error(`[Sear] Watchers must be functions! Offender: <${e}>`);this.observe(e,this._watchers[e].bind(this._proxied)),this.get(this._proxied,e)}return this._elemIDs=[],this.booleanAttributes=["async","autofocus","autoplay","checked","contenteditable","controls","default","defer","disabled","formnovalidate","frameborder","hidden","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","readonly","required","reversed","scoped","selected","typemustmatch"],document.addEventListener("DOMContentLoaded",()=>{this._frame=e.el||document.body,this.parseDOM()}),this._proxied}clone(e,t){let r;if(t&&typeof e===t[0])return t[1];if(null==e||"object"!=typeof e)return e;if(e instanceof Date)return(r=new Date).setTime(e.getTime()),r;if(Array.isArray(e)){r=[];for(let n=0;n<e.length;n++)r[n]=this.clone(e[n],t);return r}if(e.constructor===Object){r={};for(let n in e)e.hasOwnProperty(n)&&(r[n]=this.clone(e[n],t));return r}throw new Error(`[Sear] <${e.constructor.name}> is an unsupported data type!\n\nSupported data types are: (Basic) Objects, Functions, Arrays, Dates, Strings, Numbers, and Booleans.\n`)}isEqual(e,t){const r=Object.prototype.toString.call(e);if(r!==Object.prototype.toString.call(t))return!1;if(["[object Array]","[object Object]"].indexOf(r)<0)return e==t;const n="[object Array]"===r?e.length:Object.keys(e).length;if(n!==("[object Array]"===r?t.length:Object.keys(t).length))return!1;function s(e,t){const r=Object.prototype.toString.call(e);if(["[object Array]","[object Object]"].indexOf(r)>=0){if(!this.isEqual(e,t))return!1}else{if(r!==Object.prototype.toString.call(t))return!1;if("[object Function]"===r){if(e.toString()!==t.toString())return!1}else if(e!==t)return!1}return!0}if("[object Array]"===r){for(let r=0;r<n;r++)if(!1===s(e[r],t[r]))return!1}else for(let r in e)if(e.hasOwnProperty(r)&&!1===s(e[r],t[r]))return!1;return!0}persist(e,t){if(!e)return!1;const r=this.clone(t),n={};return Object.keys(r).filter(e=>"function"==typeof r[e]).forEach(e=>{n[e]=r[e].toString().trim(),delete r[e]}),localStorage[e]=JSON.stringify({data:r,computed:n})}retrieve(store){try{if(store=JSON.parse(localStorage[store]||"{}"),store&&"object"==typeof store)return store.data=store.data||{},store.computed=store.computed||{},Object.keys(store.computed).forEach(key=>{try{eval(`store.computed[key] = (${store.computed[key].startsWith("function")?"":"function"} ${store.computed[key]})`)}catch(e){store.computed[key]=new Function(`return (${store.computed[key].startsWith("function")?"":"function"} ${store.computed[key]})`)()}}),{...store.data,...store.computed}}catch(e){return{}}}observe(e,t){this._signals[e]||(this._signals[e]=[]),this._signals[e].push(t)}notify(e){this.persist(this._store,this._raw);const t=(e=Array.isArray(e)?e:e.split(".")).join("."),r=this.get(this._raw,t);for(;e.length>0;){let t=e.join(".");if(!this._signals[t]||this._signals[t].length<1)return;this._signals[t].forEach(e=>e(this.clone(this.get("function"==typeof r?this._proxied:this._cache,t)))),e.pop()}"function"!=typeof r&&this.set(this._cache,t,this.clone(r))}trapper(e=[]){const t=this;return{get(r,n){if(!(n in r))return;const s=[...e,n].join("."),i=t._dependency.targets[t._dependency.targets.length-1];if("function"==typeof r[n]){i&&!t._dependency.tracking[i].includes(s)&&t._dependency.tracking[i].push(s),t._dependency.targets.push(s),t.observe(s,()=>t.set(t._cache,s,void 0)),t.get(t._cache,s)||(t._dependency.tracking[s]=[],t.set(t._cache,s,t.clone(r[n].call(t._proxied))));const e=t.get(t._cache,s);return t._dependency.targets.pop(),e}return i&&!t._dependency.tracking[i].includes(s)&&t._dependency.tracking[i].push(s),Array.isArray(r[n])?new t.ObservableArray(r[n],[...e,n],t):"object"==typeof r[n]&&null!==r[n]?new Proxy(r[n],t.trapper([...e,n])):r[n]},set(r,n,s){if(t.isEqual(r[n],s))return!0;const i=[...e,n].join(".");return r[n]=s,Object.keys(t._dependency.tracking).forEach(e=>{t._dependency.tracking[e].includes(i)&&t.notify(e)}),t.notify([...e,n]),!0}}}arraytrapper(e=[]){const t=this;return{get:(e,t)=>e[t],set:(r,n,s)=>!!t.isEqual(r[n],s)||(r[n]=s,t.notify([...e]),!0)}}get(e,t){for(t=Array.isArray(t)?t:t.split(".");t.length>1;)if(!(e=e[t.shift()]))return;return e[t]}set(e,t,r){for(t=Array.isArray(t)?t:t.split(".");t.length>1;)if(!(e=e[t.shift()]))return;return e[t.shift()]=r,r}eID(e){let t;if(e.attributes._id)t=e.attributes._id.value;else{do{t=Math.random().toString(36).substr(2,9)}while(this._elemIDs.includes(t));e.setAttribute("_id",t),this._elemIDs.push(t)}return t}parseDOM(e=this._frame){e===document&&(e=e.body);const t=this,r={};e.querySelectorAll("[\\:pre]").forEach(e=>{const n=t.eID(e);r[n]=e.outerHTML,e.outerHTML=`<span :pre _id="${n}"></span>`}),e.innerHTML=e.innerHTML.replace(/{{([^{}]+)}}/g,'<span :text="$1"></span>'),e.querySelectorAll("[\\:text]").forEach(e=>{const r=e.attributes[":text"].value.trim();e.textContent=t.get(t._proxied,r),e.attributes[":unbound"]||t.observe(r,()=>e.textContent=t.get(t._proxied,r))}),e.querySelectorAll("[\\:html]").forEach(e=>{const r=e.attributes[":html"].value.trim();e.innerHTML=t.get(t._proxied,r),t.parseDOM(e),e.attributes[":unbound"]||t.observe(r,()=>e.innerHTML=t.get(t._proxied,r))}),e.querySelectorAll("[\\:value]").forEach(e=>{const r=e.attributes[":value"].value.trim();let n=t.get(t._proxied,r);e.attributes.type&&["radio","checkbox"].includes(e.attributes.type.value.trim())?(e.checked=n||!1,e.attributes[":unbound"]||(t.observe(r,()=>{n=t.get(t._proxied,r),e.checked=n||!1}),e.onchange=e=>t.set(t._proxied,r,e.target.checked))):(e.value=n,e.attributes[":unbound"]||(t.observe(r,()=>e.value=t.get(t._proxied,r)),e.oninput=e=>t.set(t._proxied,r,e.target.value)))}),e.querySelectorAll("[\\:if]").forEach(r=>{const n=r.attributes[":if"].value.trim(),s=t.eID(r),i=r.outerHTML,o=r.attributes[":unbound"];function a(){r.outerHTML=t.get(t._proxied,n)?i:`<span _id="${s}"></span>`,r=e.querySelector(`[_id="${s}"]`)}a(),o||t.observe(n,a)}),e.querySelectorAll("[\\:else]").forEach(r=>{const n=r.attributes[":else"].value.trim(),s=t.eID(r),i=r.outerHTML,o=r.attributes[":unbound"];function a(){r.outerHTML=t.get(t._proxied,n)?`<span _id="${s}"></span>`:i,r=e.querySelector(`[_id="${s}"]`)}a(),o||t.observe(n,a)}),e.querySelectorAll("[\\:each]").forEach(e=>{const r=e.attributes[":each"].value.trim(),n=e.firstElementChild.cloneNode(!0);function s(){const s=t.get(t._proxied,r);if(s){e.innerHTML="";for(let r=0;r<s.length;r++){const i=n.cloneNode(!0);i.innerHTML=i.innerHTML.replace(/\[\[:each:id]]/g,r+1).replace(/\[\[:each:value:html]]/g,s[r]),t.parseDOM(i),i.innerHTML=i.innerHTML.replace(/\[\[:each:value]]/g,"<span :each:value></span>"),i.querySelectorAll("[\\:each\\:value]").forEach(e=>e.textContent=s[r]),e.appendChild(i)}}}s(),e.attributes[":unbound"]||t.observe(r,s)}),Array.from(e.getElementsByTagName("*")).filter(e=>{const t=Array.from(e.attributes);for(let e=0;e<t.length;e++)if(/^:bind:.+/.test(t[e].name))return!0;return!1}).forEach(e=>{const r={};Array.from(e.attributes).filter(e=>/^:bind:.+/.test(e.name)).forEach(n=>{const s=n.name.slice(6),i=n.value.trim().split(" ").map(e=>e.split(","));function o(){let n=i.map(e=>{const r=t.get(t._proxied,e[0]);return e[1]?r?e[1]:void 0:r}).filter(e=>![null,void 0].includes(e)).join(" ");return n?t.booleanAttributes.includes(s)?["false",!1].includes(n)?e.removeAttribute(s):e.setAttribute(s,!0):e.setAttribute(s,n):[null,void 0].includes(r[s])?void e.removeAttribute(s):e.setAttribute(s,r[s])}e.attributes[s]&&(r[s]=e.attributes[s].value),o(),e.attributes[":unbound"]||i.forEach(e=>t.observe(e[0],o))})}),e.querySelectorAll("[\\:pre]").forEach(e=>e.outerHTML=r[t.eID(e)])}}