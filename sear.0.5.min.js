/*
 * Sear.js v0.5
 * (c) 2020 dragonwocky <thedragonring.bod@gmail.com>
 * (https://dragonwocky.me/) under the MIT License
 */

"use strict";class Sear{constructor(e){this._format={},e.format.version&&(this._format={version:e.format.version,handler:e.format.handler||function(){return{}}}),e.format.name&&(this._format.name=e.format.name),this._raw=this.deepmerge(e.data,{client:this.retrieve(this._format.name)}),this._cache=this.clone(this._raw,{function:()=>void 0}),this.ObservableArray=class extends Array{constructor(e,t,r){super(...e),this.__proto__.path=t,this.__proto__.parent=r;for(let e of["copyWithin","fill","pop","push","reverse","sort","shift","unshift","splice"])this[e]=(...t)=>this._update(e,...t)}_update(e,...t){const r=Array.from(this),i=r[e](...t);return this.__proto__.parent.set(this.__proto__.parent._proxied,this.__proto__.path,r),i}},this._dependency={targets:[null],tracking:{}},this._proxied=new Proxy(this._raw,this.trapper());const t=(e,r=[])=>{Object.keys(e).forEach(i=>{if("object"==typeof e[i]&&!Array.isArray(e[i]))return t(e[i],[...r,i]);"function"==typeof e[i]&&this.get(this._proxied,[...r,i])})};t(this._raw),this._signals={},this._watchers=e.watch||{};for(let e in this._watchers){if("function"!=typeof this._watchers[e])throw new Error(`[Sear] Watchers must be functions! Offender: <${e}>`);this.observe(e,this._watchers[e].bind(this._proxied)),this.get(this._proxied,e)}return this._elemIDs=[],this._preserve={},this.booleanAttributes=["async","autofocus","autoplay","checked","contenteditable","controls","default","defer","disabled","formnovalidate","frameborder","hidden","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","readonly","required","reversed","scoped","selected","typemustmatch"],document.addEventListener("DOMContentLoaded",()=>{if("el"in e){if("string"==typeof e.el&&e.el.startsWith("#")&&!e.el.includes(" ")&&(this._frame=document.getElementById(e.el.slice(1)),!this._frame))throw new Error(`[Sear] Element <${e.el}> does not exist!`);if(!this._frame)throw new Error(`[Sear] Element <${e.el}> is invalid!\nElement must be passed as a single ID in a string (e.g. '#app').`)}else this._frame=document.body;this.parseDOM()}),this._proxied}compare(e,t){if(typeof e!=typeof t||Array.isArray(e)!=Array.isArray(t))return!1;if("object"==typeof e)if(Array.isArray(e)){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!this.compare(e[r],t[r]))return!1}else{if(Object.keys(e).length!==Object.keys(t).length)return!1;for(let r in e)if(!this.compare(e[r],t[r]))return!1}else if("function"==typeof e){if(e.toString()!==t.toString())return!1}else if(e!==t)return!1;return!0}deepmerge(...e){if(!e.length)return{};const t={},r=(e,i=[])=>{Object.keys(e).forEach(s=>{if("object"==typeof e[s]&&!Array.isArray(e[s]))return r(e[s],[...i,s]);this.set(t,[...i,s],e[s])})};return e.forEach(e=>r(this.clone(e))),t}clone(e,t){let r;if("object"==typeof t)for(let[r,i]of Object.entries(t))if(typeof e===r)return i(e);if(null===e||"object"!=typeof e)return e;if(e instanceof Date)return new Date((new Date).setTime(e.getTime()));if(Array.isArray(e)){r=[];for(let i=0;i<e.length;i++)r[i]=this.clone(e[i],t);return r}if(e.constructor===Object){r={};for(let i in e)r[i]=this.clone(e[i],t);return r}throw new Error(`[Sear] <${e.constructor.name}> is an unsupported data type!\n\nSupported data types are: (Basic) Objects, Functions, Arrays, Dates, Strings, Numbers, and Booleans.\n`)}persist(e,t){if(!e)return!1;const r=this.clone(t).client,i={},s=(e,t=[])=>{Object.keys(e).filter(t=>"object"==typeof e[t]).forEach(r=>{this.set(i,[...t,r],{}),s(e[r],[...t,r])}),Object.keys(e).filter(t=>"function"==typeof e[t]).forEach(r=>{this.set(i,[...t,r],e[r]),delete e[r]})};s(r);const n={data:r,computed:i};return"version"in this._format&&(n.version=this._format.version),localStorage[e]=JSON.stringify(n)}retrieve(e){if(!e)return{};try{if((e=JSON.parse(localStorage[e]||"{}"))&&"object"==typeof e){e.data=e.data||{},e.computed=e.computed||{};const t=(r,i=[])=>{Object.keys(r).forEach(s=>"object"==typeof r[s]?t(r[s],[...i,s]):this.set(e.computed,[...i,s],new Function(`return (${r[s].startsWith("function")?"":"function"} ${r[s]})`)()))};t(e.computed);const r=this.deepmerge(e.data,e.computed);return e.version!==this._format.version?this._format.handler(r):r}}catch(e){return{}}}observe(e,t){this._signals[e]||(this._signals[e]=[]),this._signals[e].push(t)}notify(e){this.persist(this._format.name,this._raw);const t=(e=Array.isArray(e)?e:e.split(".")).join("."),r=this.get(this._raw,t);for(;e.length;){let t=e.join(".");this._signals[t]&&this._signals[t].forEach(e=>{"function"==typeof this.get(this._raw,t)&&this.set(this._cache,t,void 0),e(this.clone(this.get(this._cache,t)))}),e.pop()}return"function"!=typeof r&&this.set(this._cache,t,this.clone(r)),!0}trapper(e=[]){const t=this;return{get(r,i){if(!(i in r))return;const s=[...e,i].join("."),n=t._dependency.targets[t._dependency.targets.length-1],o=t._dependency.tracking[n];return"function"==typeof r[i]?(n&&!o.includes(s)&&o.push(s),t._dependency.targets.push(s),t.get(t._cache,s)||(t._dependency.tracking[s]=[],t.set(t._cache,s,t.clone(r[i].call(t._proxied)))),t._dependency.targets.pop(),t.get(t._cache,s)):(n&&!o.includes(s)&&o.push(s),Array.isArray(r[i])?new t.ObservableArray(r[i],[...e,i],t):"object"==typeof r[i]&&null!==r[i]?new Proxy(r[i],t.trapper([...e,i])):r[i])},set:(r,i,s)=>!!t.compare(r[i],s)||(r[i]=s,Object.keys(t._dependency.tracking).forEach(r=>{t._dependency.tracking[r].includes([...e,i].join("."))&&t.notify(r)}),t.notify([...e,i]),!0)}}get(e,t){for(t=Array.isArray(t)?t:t.split(".");t.length>1;)if(!(e=e[t.shift()]))return;return e[t]}set(e,t,r){for(t=Array.isArray(t)?t:t.split(".");t.length>1;){const r=t.shift();e[r]||(e[r]={}),e=e[r]}return e[t.shift()]=r,r}eID(e){let t;if(e.attributes._id)t=e.attributes._id.value;else{do{t=Math.random().toString(36).substr(2,9)}while(this._elemIDs.includes(t));e.setAttribute("_id",t),this._elemIDs.push(t)}return t}reactive(e,t){if(e&&t)return{id:this.eID(t),node(){return e.querySelector(`[_id="${this.id}"]`)}}}parseDOM(e=this._frame){e===document&&(e=e.body),e.querySelectorAll("[\\:pre]").forEach(e=>{const t=this.eID(e);this._preserve[t]||(this._preserve[t]=e.outerHTML,e.outerHTML=`<span :pre _id="${t}"></span>`)}),e.innerHTML=e.innerHTML.replace(/{{([^{}]+)}}/g,'<span :text="$1"></span>'),e.querySelectorAll("[\\:text]").forEach(t=>{const r=(t=this.reactive(e,t)).node().attributes[":text"].value.trim(),i=()=>{t.node()&&(t.node().textContent=this.get(this._proxied,r))};t.node().attributes[":unbound"]||this.observe(r,i),i()}),e.querySelectorAll("[\\:html]").forEach(t=>{const r=(t=this.reactive(e,t)).node().attributes[":html"].value.trim(),i=()=>{t.node()&&(t.node().innerHTML=this.get(this._proxied,r),this.parseDOM(t.node()))};t.node().attributes[":unbound"]||this.observe(r,i),i()}),e.querySelectorAll("[\\:value]").forEach(t=>{const r=(t=this.reactive(e,t)).node().attributes[":value"].value.trim(),i=()=>{t.node()&&(["radio","checkbox"].includes(t.node().type)?(t.node().checked=1==this.get(this._proxied,r),t.node().onchange=e=>this.set(this._proxied,r,e.target.checked)):(t.node().value=this.get(this._proxied,r),t.node().oninput=e=>this.set(this._proxied,r,e.target.value)))};t.node().attributes[":unbound"]||this.observe(r,i),i()}),e.querySelectorAll("[\\:each]").forEach(t=>{const r=(t=this.reactive(e,t)).node().attributes[":each"].value.trim(),i=t.node().firstElementChild.cloneNode(!0),s=()=>{if(!t.node())return;t.node().innerHTML="";const e=this.get(this._proxied,r);if(Array.isArray(e))for(let r=0;r<e.length;r++){const s=i.cloneNode(!0);s.innerHTML=s.innerHTML.replace(/\[\[:each:id]]/g,r+1).replace(/\[\[:each:value:html]]/g,e[r]),this.parseDOM(s),s.innerHTML=s.innerHTML.replace(/\[\[:each:value]]/g,"<span :each:value></span>"),s.querySelectorAll("[\\:each\\:value]").forEach(t=>t.textContent=e[r]),t.node().appendChild(s)}};t.node().attributes[":unbound"]||this.observe(r,s),s()}),Array.from(e.getElementsByTagName("*")).filter(e=>{const t=Array.from(e.attributes);for(let e=0;e<t.length;e++)if(/^:bind:.+/.test(t[e].name))return!0;return!1}).forEach(t=>{t=this.reactive(e,t);const r={};Array.from(t.node().attributes).filter(e=>/^:bind:.+/.test(e.name)).forEach(e=>{const i=e.name.slice(6),s=e.value.trim().split(" ").map(e=>e.split("="));t.node().attributes[i]&&(r[i]=t.node().attributes[i].value);const n=()=>{if(!t.node())return;let e=s.map(e=>{const t=this.get(this._proxied,e[0]);return e[1]?t?e[1]:void 0:t}).filter(e=>![null,void 0].includes(e)).join(" ");return""!==e?this.booleanAttributes.includes(i)?"false"===e.trim()?t.node().removeAttribute(i):t.node().setAttribute(i,!0):t.node().setAttribute(i,`${r[i]?r[i]:""} ${e}`):[null,void 0].includes(r[i])?void t.node().removeAttribute(i):t.node().setAttribute(i,r[i])};t.node().attributes[":unbound"]||s.forEach(e=>this.observe(e[0],n)),n()})}),e.querySelectorAll("[\\:if]").forEach(t=>{const r=(t=this.reactive(e,t)).node().attributes[":if"].value.trim(),i=t.node().outerHTML,s=()=>{if(!t.node())return;const e=this.get(this._proxied,r);t.node().outerHTML=(e.length?e.length:1==e)?i:`<span _id="${t.id}"></span>`,this.parseDOM(t.node())};t.node().attributes[":unbound"]||this.observe(r,s),s()}),e.querySelectorAll("[\\:else]").forEach(t=>{const r=(t=this.reactive(e,t)).node().attributes[":else"].value.trim(),i=t.node().outerHTML,s=()=>{if(!t.node())return;const e=this.get(this._proxied,r);t.node().outerHTML=(e.length?e.length:1==e)?`<span _id="${t.id}"></span>`:i,this.parseDOM(t.node())};t.node().attributes[":unbound"]||this.observe(r,s),s()}),e.querySelectorAll("[\\:pre]").forEach(e=>e.outerHTML=this._preserve[this.eID(e)])}}