/*
  * Sear.js 0.5.3
  * (c) 2020 dragonwocky <thedragonring.bod@gmail.com>
  * (https://dragonwocky.me/) under the MIT License
  */

"use strict";class Sear{constructor(t){this.t={},t.format.version&&(this.t={version:t.format.version,handler:t.format.handler||function(){return{}}}),t.format.name&&(this.t.name=t.format.name),this.i=this.s(t.data,{client:this.h(this.t.name)}),this.o=this.clone(this.i,[["function",()=>{}]]),this.u=class extends Array{constructor(t,e,i){super(...t),this.__proto__.path=e,this.__proto__.parent=i;for(let t of["copyWithin","fill","pop","push","reverse","sort","shift","unshift","splice"])this[t]=(...e)=>this.l(t,...e)}l(t,...e){const i=Array.from(this),s=i[t](...e);return this.__proto__.parent.set(this.__proto__.parent.p,this.__proto__.path,i),s}},this.m={v:[null],j:{}},this.p=new Proxy(this.i,this.A());const e=(t,i=[])=>{Object.keys(t).forEach(s=>{if("object"==typeof t[s]&&!Array.isArray(t[s]))return e(t[s],[...i,s]);"function"==typeof t[s]&&this.get(this.p,[...i,s])})};e(this.i),this.g={},this.O=t.watch||{};for(let t in this.O){if("function"!=typeof this.O[t])throw new Error(`[Sear] Watchers must be functions! Offender: <${t}>`);this.observe(t,this.O[t].bind(this.p)),this.get(this.p,t)}return this.$=[],this.S={},this.D=["async","autofocus","autoplay","checked","contenteditable","controls","default","defer","disabled","formnovalidate","frameborder","hidden","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","readonly","required","reversed","scoped","selected","typemustmatch"],document.addEventListener("DOMContentLoaded",()=>{if("el"in t){if("string"==typeof t.el&&t.el.startsWith("#")&&!t.el.includes(" ")&&(this._=document.getElementById(t.el.slice(1)),!this._))throw new Error(`[Sear] Element <${t.el}> does not exist!`);if(!this._)throw new Error(`[Sear] Element <${t.el}> is invalid!\nElement must be passed as a single ID in a string (e.g. '#app').`)}else this._=document.body;this.k()}),this.p}M(t,e){if(typeof t!=typeof e||Array.isArray(t)!=Array.isArray(e))return!1;if("object"==typeof t)if(Array.isArray(t)){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!this.M(t[i],e[i]))return!1}else{if(Object.keys(t).length!==Object.keys(e).length)return!1;for(let i in t)if(!this.M(t[i],e[i]))return!1}else if("function"==typeof t){if(t.toString()!==e.toString())return!1}else if(t!==e)return!1;return!0}s(...t){if(!t.length)return{};const e={},i=(t,s=[])=>{Object.keys(t).forEach(r=>{if("object"==typeof t[r]&&!Array.isArray(t[r]))return i(t[r],[...s,r]);this.set(e,[...s,r],t[r])})};return t.forEach(t=>i(this.clone(t))),e}clone(t,e){let i;if("object"==typeof e)for(let[i,s]of e)if(typeof t===i)return s(t);if(null===t||"object"!=typeof t)return t;if(t instanceof Date)return new Date((new Date).setTime(t.getTime()));if(Array.isArray(t)){i=[];for(let s=0;s<t.length;s++)i[s]=this.clone(t[s],e);return i}if(t.constructor===Object){i={};for(let s in t)i[s]=this.clone(t[s],e);return i}throw new Error(`[Sear] <${t.constructor.name}> is an unsupported data type!\n\nSupported data types are: (Basic) Objects, Functions, Arrays, Dates, Strings, Numbers, and Booleans.\n`)}N(t,e){if(!t)return!1;const i={data:this.clone(e).client,computed:{}},s=(t,e=[])=>{Object.keys(t).filter(e=>"object"==typeof t[e]).forEach(r=>{this.set(i.computed,[...e,r],{}),s(t[r],[...e,r])}),Object.keys(t).filter(e=>"function"==typeof t[e]).forEach(s=>{this.set(i.computed,[...e,s],t[s]),delete t[s]})};return s(i.data),"version"in this.t&&(i.version=this.t.version),localStorage[t]=JSON.stringify(i)}h(t){if(!t)return{};try{if((t=JSON.parse(localStorage[t]||"{}"))&&"object"==typeof t){t.data=t.data||{},t.computed=t.computed||{};const e=(i,s=[])=>{Object.keys(i).forEach(r=>"object"==typeof i[r]?e(i[r],[...s,r]):this.set(t.computed,[...s,r],new Function(`return (${i[r].startsWith("function")?"":"function"} ${i[r]})`)()))};e(t.computed);const i=this.s(t.data,t.computed);return t.version!==this.t.version?this.t.handler(i):i}}catch(t){return{}}}observe(t,e){this.g[t]||(this.g[t]=[]),this.g[t].push(e)}B(t){this.N(this.t.name,this.i);const e=(t=Array.isArray(t)?t:t.split(".")).join("."),i=this.get(this.i,e);for(;t.length;){let e=t.join(".");this.g[e]&&this.g[e].forEach(t=>{"function"==typeof this.get(this.i,e)&&this.set(this.o,e,void 0),t(this.clone(this.get(this.o,e)))}),t.pop()}return"function"!=typeof i&&this.set(this.o,e,this.clone(i)),!0}A(t=[]){const e=this;return{get(i,s){if(!(s in i))return;const r=[...t,s].join("."),n=e.m.v[e.m.v.length-1],h=e.m.j[n];return"function"==typeof i[s]?(n&&!h.includes(r)&&h.push(r),e.m.v.push(r),e.get(e.o,r)||(e.m.j[r]=[],e.set(e.o,r,e.clone(i[s].call(e.p)))),e.m.v.pop(),e.get(e.o,r)):(n&&!h.includes(r)&&h.push(r),Array.isArray(i[s])?new e.u(i[s],[...t,s],e):"object"==typeof i[s]&&null!==i[s]?new Proxy(i[s],e.A([...t,s])):i[s])},set:(i,s,r)=>!!e.M(i[s],r)||(i[s]=r,Object.keys(e.m.j).forEach(i=>{e.m.j[i].includes([...t,s].join("."))&&e.B(i)}),e.B([...t,s]),!0)}}get(t,e){for(e=Array.isArray(e)?e:e.split(".");e.length>1;)if(!(t=t[e.shift()]))return;return t[e]}set(t,e,i){for(e=Array.isArray(e)?e:e.split(".");e.length>1;){const i=e.shift();t[i]||(t[i]={}),t=t[i]}return t[e.shift()]=i,i}F(t){let e;if(t.attributes._id)e=t.attributes._id.value;else{do{e=Math.random().toString(36).substr(2,9)}while(this.$.includes(e));t.setAttribute("_id",e),this.$.push(e)}return e}I(t,e){if(t&&e)return{id:this.F(e),J(){return t.querySelector(`[_id="${this.id}"]`)}}}k(t=this._){t===document&&(t=t.body),t.querySelectorAll("[\\:pre]").forEach(t=>{const e=this.F(t);this.S[e]||(this.S[e]=t.outerHTML,t.outerHTML=`<span :pre _id="${e}"></span>`)}),t.innerHTML=t.innerHTML.replace(/{{([^{}]+)}}/g,'<span :text="$1"></span>'),t.querySelectorAll("[\\:text]").forEach(e=>{const i=(e=this.I(t,e)).J().attributes[":text"].value.trim(),s=()=>{e.J()&&(e.J().textContent=this.get(this.p,i))};e.J().attributes[":unbound"]||this.observe(i,s),s()}),t.querySelectorAll("[\\:html]").forEach(e=>{const i=(e=this.I(t,e)).J().attributes[":html"].value.trim(),s=()=>{e.J()&&(e.J().innerHTML=this.get(this.p,i),this.k(e.J()))};e.J().attributes[":unbound"]||this.observe(i,s),s()}),t.querySelectorAll("[\\:value]").forEach(e=>{const i=(e=this.I(t,e)).J().attributes[":value"].value.trim(),s=()=>{e.J()&&(["radio","checkbox"].includes(e.J().type)?(e.J().checked=1==this.get(this.p,i),e.J().onchange=t=>this.set(this.p,i,t.target.checked)):(e.J().value=this.get(this.p,i),e.J().oninput=t=>this.set(this.p,i,t.target.value)))};e.J().attributes[":unbound"]||this.observe(i,s),s()}),t.querySelectorAll("[\\:each]").forEach(e=>{const i=(e=this.I(t,e)).J().attributes[":each"].value.trim(),s=e.J().firstElementChild.cloneNode(!0),r=()=>{if(!e.J())return;e.J().innerHTML="";const t=this.get(this.p,i);if(Array.isArray(t))for(let i=0;i<t.length;i++){const r=s.cloneNode(!0);r.innerHTML=r.innerHTML.replace(/\[\[:each:id]]/g,i+1).replace(/\[\[:each:value:html]]/g,t[i]),this.k(r),r.innerHTML=r.innerHTML.replace(/\[\[:each:value]]/g,"<span :each:value></span>"),r.querySelectorAll("[\\:each\\:value]").forEach(e=>e.textContent=t[i]),e.J().appendChild(r)}};e.J().attributes[":unbound"]||this.observe(i,r),r()}),Array.from(t.getElementsByTagName("*")).filter(t=>{const e=Array.from(t.attributes);for(let t=0;t<e.length;t++)if(/^:bind:.+/.test(e[t].name))return!0;return!1}).forEach(e=>{e=this.I(t,e);const i={};Array.from(e.J().attributes).filter(t=>/^:bind:.+/.test(t.name)).forEach(t=>{const s=t.name.slice(6),r=t.value.trim().split(" ").map(t=>t.split("="));e.J().attributes[s]&&(i[s]=e.J().attributes[s].value);const n=()=>{if(!e.J())return;let t=r.map(t=>{const e=this.get(this.p,t[0]);return t[1]?e?t[1]:void 0:e}).filter(t=>![null,void 0].includes(t)).join(" ");return""!==t?this.D.includes(s)?"false"===t.trim()?e.J().removeAttribute(s):e.J().setAttribute(s,!0):e.J().setAttribute(s,`${i[s]?i[s]:""} ${t}`):[null,void 0].includes(i[s])?void e.J().removeAttribute(s):e.J().setAttribute(s,i[s])};e.J().attributes[":unbound"]||r.forEach(t=>this.observe(t[0],n)),n()})}),t.querySelectorAll("[\\:if]").forEach(e=>{const i=(e=this.I(t,e)).J().attributes[":if"].value.trim(),s=e.J().outerHTML,r=()=>{const t=this.get(this.p,i);e.J()&&(e.J().outerHTML=(t.length?t.length:1==t)?s:`<span _id="${e.id}"></span>`,this.k(e.J()))};e.J().attributes[":unbound"]||this.observe(i,r),r()}),t.querySelectorAll("[\\:else]").forEach(e=>{const i=(e=this.I(t,e)).J().attributes[":else"].value.trim(),s=e.J().outerHTML,r=()=>{const t=this.get(this.p,i);e.J()&&(e.J().outerHTML=(t.length?t.length:1==t)?`<span _id="${e.id}"></span>`:s,this.k(e.J()))};e.J().attributes[":unbound"]||this.observe(i,r),r()}),t.querySelectorAll("[\\:pre]").forEach(t=>t.outerHTML=this.S[this.F(t)])}}
